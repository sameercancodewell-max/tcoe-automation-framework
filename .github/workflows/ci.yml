name: Java CI with Gradle

on:
  push:
    branches: [ main, feature/* ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Build with Gradle
      run: ./gradlew build --no-configuration-cache

    - name: Run tests
      run: ./gradlew test --no-configuration-cache

    - name: Generate test report
      if: always()
      run: ./gradlew jacocoTestReport --no-configuration-cache

    - name: SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@v3
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        args: >
          -Dsonar.projectKey=sameercancodewell-max_tcoe-automation-framework
          -Dsonar.organization=sameercancodewell-max
          -Dsonar.sources=app/src/main/java
          -Dsonar.tests=app/src/test/java
          -Dsonar.java.binaries=app/build/classes
          -Dsonar.coverage.jacoco.xmlReportPaths=app/build/reports/jacoco/test/jacocoTestReport.xml
          -Dsonar.junit.reportPaths=app/build/test-results/test

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: app/build/reports/tests/test/

    - name: Upload coverage report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: app/build/reports/jacoco/test/html/

    - name: Setup Allure
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        wget https://github.com/allure-framework/allure2/releases/download/2.24.0/allure-2.24.0.tgz
        tar -zxvf allure-2.24.0.tgz
        sudo mv allure-2.24.0 /opt/allure
        sudo ln -s /opt/allure/bin/allure /usr/bin/allure
        allure --version

    - name: Prepare Reports for GitHub Pages
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        mkdir -p reports-site/jacoco
        mkdir -p reports-site/allure
        
        # Copy JaCoCo reports
        cp -r app/build/reports/jacoco/test/html/* reports-site/jacoco/ || echo "JaCoCo reports not found"
        
        # Generate and copy Allure reports
        allure generate app/build/allure-results -o reports-site/allure --clean || echo "Allure generation failed"
        
        # Create index page
        cat > reports-site/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <title>TCOE Test Reports</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
                .container { max-width: 800px; margin: 0 auto; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                h1 { color: #333; border-bottom: 3px solid #4CAF50; padding-bottom: 10px; }
                .report-card { background: #f9f9f9; padding: 20px; margin: 20px 0; border-radius: 5px; border-left: 4px solid #4CAF50; }
                .report-card h2 { margin-top: 0; color: #4CAF50; }
                .report-card a { display: inline-block; margin-top: 10px; padding: 10px 20px; background: #4CAF50; color: white; text-decoration: none; border-radius: 4px; }
                .report-card a:hover { background: #45a049; }
                .report-card.external { border-left-color: #FF9800; }
                .report-card.external h2 { color: #FF9800; }
                .report-card.external a { background: #FF9800; }
                .report-card.external a:hover { background: #F57C00; }
                .footer { text-align: center; margin-top: 40px; color: #999; font-size: 14px; }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>üè† Test Center of Excellence - Reports Dashboard</h1>
                <p>Last Updated: $(date)</p>
                
                <div class="report-card">
                    <h2>üìä Code Coverage Report (JaCoCo)</h2>
                    <p>Detailed line-by-line code coverage analysis</p>
                    <a href="jacoco/index.html">View JaCoCo Report ‚Üí</a>
                </div>
                
                <div class="report-card">
                    <h2>üéØ Test Execution Report (Allure)</h2>
                    <p>Beautiful test results with history and trends</p>
                    <a href="allure/index.html">View Allure Report ‚Üí</a>
                </div>
                
                <div class="report-card external">
                    <h2>üîç Code Quality Report (SonarCloud)</h2>
                    <p>Code quality metrics, security issues, and technical debt analysis</p>
                    <a href="https://sonarcloud.io/summary/overall?id=sameercancodewell-max_tcoe-automation-framework&branch=main" target="_blank">View SonarCloud Report ‚Üí</a>
                </div>
                
                <div class="footer">
                    <p>Generated by GitHub Actions | TCOE Automation Framework</p>
                </div>
            </div>
        </body>
        </html>
        EOF

    - name: Deploy Reports to GitHub Pages
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./reports-site
        commit_message: 'docs: Update test reports'